<html>
  <head>
    <script
      src="https://cdn.plot.ly/plotly-3.0.1.min.js"
      charset="utf-8"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <title>Hydro Plantage</title>
  </head>

  <body>
    <h1>Test</h1>
    <form method="POST" action="https://192.168.0.100:8081/api/add_ph.php">
      Name: <input type="number" name="ph_value" />
      <input type="submit" />
    </form>

    <button>Send an HTTP POST request to a page and get the result back</button>

    <div id="Sensor 1" style="width: 600px; height: 650px"></div>
    <div id="Sensor 2" style="width: 600px; height: 650px"></div>
    <div id="Sensor 3" style="width: 600px; height: 650px"></div>
    <div id="Sensor 4" style="width: 600px; height: 650px"></div>
    <div id="Sensor 5" style="width: 600px; height: 650px"></div>
    <script>
      function loadPlotData() {
        $.post(
          "https://192.168.0.100:8081/api/get_ph.php",
          function (data, status) {
            if (status === "success") {

              const jsonData =
                typeof data === "string" ? JSON.parse(data) : data;

              const sensors = new Map();

              jsonData.forEach((entry) => {
                if(!sensors.has(entry.sensor_id)) {
                  sensors.set(entry.sensor_id, {
                    sensor_id: entry.sensor_id,
                    ph_value: [],
                    mess_time: []
                  });
                }
                
                const sensor = sensors.get(entry.sensor_id);
                sensor.ph_value.push(entry.ph_value);
                sensor.mess_time.push(entry.mess_time);
              });

              sensors.forEach((entry) => {
              Plotly.newPlot(
                "Sensor " + entry.sensor_id,
                [
                  {
                    x: entry.mess_time,
                    y: entry.ph_value,
                    type: "scatter",
                    mode: "lines+markers",
                    line: { shape: "spline" },
                    marker: { color: "blue" },
                  },
                ],
                {
                  title: "pH-Werte der letzten 60 Minuten",
                  xaxis: { title: "Zeit" },
                  yaxis: { title: "pH-Wert" },
                },
              );
              })
              
            } else {
              console.error("Datenabruf fehlgeschlagen");
            }
          },
        );
      }
      $(document).ready(loadPlotData());
      setInterval(loadPlotData, 60 * 1000);
    </script>
  </body>
</html>
